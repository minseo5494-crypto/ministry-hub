# 교회 엔티티 구조 변경 계획

## 1. 개요

### 1.1 목적
- 교회를 독립 엔티티로 분리하여 명확한 계층 구조 구현
- 예배를 교회 단위로 관리
- 다양한 사용자 유형 지원 (단일팀, 다중팀, 다중교회)

### 1.2 사용자 유형
| 유형 | 설명 | 예시 |
|------|------|------|
| 일반 팀원 | 1교회, 1팀 | OO교회 찬양팀 |
| 다중팀 사역자 | 1교회, 여러팀 | OO교회 청년부+중등부 찬양팀 |
| 다중교회 사역자 | 여러교회, 여러팀 | OO교회 + XX교회 사역 |

---

## 2. 데이터베이스 변경

### 2.1 새 테이블: churches (교회)

```sql
CREATE TABLE churches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,                    -- 교회명
  description TEXT,                      -- 교회 소개
  location TEXT,                         -- 주소/위치
  website_url TEXT,                      -- 웹사이트
  logo_url TEXT,                         -- 로고 이미지
  invite_code TEXT UNIQUE NOT NULL,      -- 초대 코드
  is_public BOOLEAN DEFAULT false,       -- 공개 교회 여부 (탐색 가능)
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- RLS 정책
ALTER TABLE churches ENABLE ROW LEVEL SECURITY;
```

### 2.2 새 테이블: church_members (교회 멤버)

```sql
CREATE TABLE church_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  church_id UUID NOT NULL REFERENCES churches(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('admin', 'leader', 'member')),
  joined_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(church_id, user_id)
);

-- RLS 정책
ALTER TABLE church_members ENABLE ROW LEVEL SECURITY;
```

### 2.3 테이블 수정: teams

```sql
-- church_id 컬럼 추가
ALTER TABLE teams ADD COLUMN church_id UUID REFERENCES churches(id);

-- 기존 church_name 데이터를 churches 테이블로 마이그레이션 후
-- church_name 컬럼은 유지 (호환성) 또는 제거
```

### 2.4 테이블 수정: services (예배)

```sql
-- church_id 컬럼 추가 (예배는 교회 소속)
ALTER TABLE services ADD COLUMN church_id UUID REFERENCES churches(id);

-- team_id는 "담당팀"으로 유지 (nullable)
-- 이미 team_id가 있으므로 구조 변경 최소화
```

### 2.5 선택적: 셋리스트 공개 설정

```sql
-- team_setlists에 공개 설정 추가
ALTER TABLE team_setlists ADD COLUMN is_public BOOLEAN DEFAULT false;
ALTER TABLE team_setlists ADD COLUMN public_title TEXT;  -- 공개시 표시할 제목
```

---

## 3. 마이그레이션 전략

### 3.1 단계별 진행

#### Phase 1: 테이블 생성 (비파괴적)
1. `churches` 테이블 생성
2. `church_members` 테이블 생성
3. `teams.church_id` 컬럼 추가 (nullable)
4. `services.church_id` 컬럼 추가 (nullable)

#### Phase 2: 데이터 마이그레이션
1. 기존 `teams.church_name`에서 고유한 교회 추출
2. `churches` 테이블에 교회 데이터 생성
3. `teams.church_id` 연결
4. `services.church_id` 연결 (team의 church_id 기준)
5. 팀 생성자를 church_members (admin)으로 추가

#### Phase 3: 코드 업데이트
1. 새 API/페이지 추가 (교회 관리)
2. 기존 페이지 수정 (my-team → 교회 선택 추가)
3. 예배 관리 UI 수정

#### Phase 4: 정리
1. 기존 `teams.church_name` 컬럼 deprecate (유지 또는 제거)
2. 테스트 및 검증

---

## 4. UI/UX 변경

### 4.1 네비게이션 구조 변경

**현재:**
```
/my-team/[teamId]
 ├── /services
 ├── /setlist
 └── /settings
```

**변경 후:**
```
/my-church/[churchId]
 ├── /services (교회 예배 목록)
 ├── /teams (교회 내 팀들)
 └── /settings (교회 설정)

/my-team/[teamId]
 ├── /setlist (팀 셋리스트)
 └── /settings (팀 설정)
```

### 4.2 새 페이지

| 경로 | 설명 |
|------|------|
| `/my-churches` | 내가 속한 교회 목록 |
| `/my-church/[id]` | 교회 대시보드 |
| `/my-church/[id]/services` | 교회 예배 관리 |
| `/my-church/[id]/teams` | 교회 내 팀 목록 |
| `/church/create` | 교회 생성 |
| `/church/join` | 교회 가입 (초대코드) |
| `/explore/churches` | 공개 교회 탐색 |
| `/explore/playlists` | 공개 플레이리스트 탐색 |

### 4.3 홈 화면 변경

```
홈 (/)
 ├── 내 교회들 섹션
 │    ├── OO교회 → 클릭시 /my-church/[id]
 │    └── XX교회 → 클릭시 /my-church/[id]
 │
 ├── 다가오는 예배 섹션 (모든 교회 통합)
 │    ├── 1/26 OO교회 주일예배
 │    └── 1/26 XX교회 청년예배
 │
 └── 내 팀들 섹션
      ├── OO교회 - 찬양팀
      └── XX교회 - 청년찬양팀
```

---

## 5. 권한 체계

### 5.1 교회 레벨
| 역할 | 권한 |
|------|------|
| admin | 교회 설정, 팀 생성/삭제, 멤버 관리, 예배 관리 |
| leader | 예배 생성/수정, 팀 관리 |
| member | 예배 조회, 팀 가입 |

### 5.2 팀 레벨 (기존 유지)
| 역할 | 권한 |
|------|------|
| admin | 팀 설정, 멤버 관리 |
| leader | 셋리스트 관리 |
| member | 셋리스트 조회 |

---

## 6. 플레이리스트 공개 기능

### 6.1 공개 설정
- 팀 셋리스트를 "공개"로 설정 가능
- 공개된 셋리스트는 다른 팀/교회에서 조회 가능
- 공개시 팀명, 교회명 표시 여부 선택

### 6.2 탐색 기능
- `/explore/playlists`: 공개 플레이리스트 검색/탐색
- 필터: 기간, 교회, 테마 등
- "이 팀 팔로우" 기능 (선택적, 추후 구현)

---

## 7. 구현 우선순위

### 7.1 MVP (1차)
1. ✅ churches, church_members 테이블 생성
2. ✅ 기존 데이터 마이그레이션
3. ✅ 교회 생성/가입 페이지
4. ✅ 내 교회 목록 페이지
5. ✅ 교회 대시보드 (예배 목록)
6. ✅ teams에 church_id 연결

### 7.2 2차
1. 예배를 교회 단위로 관리하도록 UI 수정
2. 팀 셋리스트 공개 기능
3. 공개 플레이리스트 탐색 페이지

### 7.3 3차 (선택적)
1. 교회/팀 팔로우 기능
2. 공개 교회 프로필 페이지
3. 통계 대시보드 (교회 단위)

---

## 8. 호환성 고려사항

### 8.1 기존 사용자
- 기존 팀은 자동으로 교회 생성 및 연결
- 기존 예배/셋리스트 데이터 유지
- 기존 URL 패턴 유지 (리다이렉트 처리)

### 8.2 점진적 전환
- church_id가 없는 팀도 정상 동작
- 새 기능은 교회가 설정된 경우에만 활성화

---

## 9. 예상 작업 시간

| 작업 | 예상 시간 |
|------|----------|
| DB 마이그레이션 | 1시간 |
| 교회 생성/가입 페이지 | 2시간 |
| 내 교회 목록/대시보드 | 2시간 |
| 기존 페이지 수정 | 2시간 |
| 테스트 및 버그 수정 | 1시간 |
| **총계** | **~8시간** |

---

## 10. 체크리스트

### Phase 1: DB
- [ ] churches 테이블 생성
- [ ] church_members 테이블 생성
- [ ] teams.church_id 컬럼 추가
- [ ] services.church_id 컬럼 추가
- [ ] RLS 정책 설정
- [ ] 기존 데이터 마이그레이션

### Phase 2: 백엔드/API
- [ ] 교회 CRUD API (Supabase RLS로 처리)
- [ ] 교회 멤버 관리 API
- [ ] 초대 코드 생성/검증

### Phase 3: 프론트엔드
- [ ] /church/create 페이지
- [ ] /church/join 페이지
- [ ] /my-churches 페이지
- [ ] /my-church/[id] 대시보드
- [ ] /my-church/[id]/services 페이지
- [ ] /my-church/[id]/teams 페이지
- [ ] 기존 /my-team 페이지에 교회 컨텍스트 추가
- [ ] 홈 화면 수정

### Phase 4: 마무리
- [ ] 테스트
- [ ] 기존 사용자 마이그레이션 확인
- [ ] 문서 업데이트
